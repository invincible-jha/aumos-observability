version: "3.9"

# ============================================================================
# AumOS Observability Stack — Full local development environment
# Starts all 7 infrastructure services + the observability API
# ============================================================================

services:
  app:
    build: .
    ports:
      - "8000:8000"
    env_file: .env
    depends_on:
      postgres:
        condition: service_healthy
      prometheus:
        condition: service_started
      grafana:
        condition: service_started
      loki:
        condition: service_started
      kafka:
        condition: service_started
    volumes:
      - ./src:/app/src
    environment:
      AUMOS_OBSERVABILITY_PROMETHEUS_URL: http://prometheus:9090
      AUMOS_OBSERVABILITY_GRAFANA_URL: http://grafana:3000
      AUMOS_OBSERVABILITY_LOKI_URL: http://loki:3100
      AUMOS_OBSERVABILITY_LANGFUSE_URL: http://langfuse:3000
      AUMOS_OBSERVABILITY_JAEGER_URL: http://jaeger:16686
      AUMOS_OBSERVABILITY_OTEL_COLLECTOR_GRPC_ENDPOINT: otel-collector:4317
      AUMOS_OBSERVABILITY_OTEL_COLLECTOR_HTTP_ENDPOINT: http://otel-collector:4318

  # ─────────────────────────────────────────────
  # PostgreSQL (state store for SLOs, alert rules, dashboards)
  # ─────────────────────────────────────────────
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: aumos
      POSTGRES_PASSWORD: aumos_dev
      POSTGRES_DB: aumos
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aumos"]
      interval: 5s
      timeout: 3s
      retries: 5
    volumes:
      - pgdata:/var/lib/postgresql/data

  # ─────────────────────────────────────────────
  # Prometheus (metrics + alerting)
  # ─────────────────────────────────────────────
  prometheus:
    image: prom/prometheus:v2.51.0
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus-config:/etc/prometheus
      - promdata:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"

  # ─────────────────────────────────────────────
  # Grafana (dashboards)
  # ─────────────────────────────────────────────
  grafana:
    image: grafana/grafana:10.4.0
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SECURITY_ADMIN_USER: admin
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_INSTALL_PLUGINS: ""
    volumes:
      - grafanadata:/var/lib/grafana
      - ./grafana-dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
      - loki

  # ─────────────────────────────────────────────
  # Loki (log aggregation)
  # ─────────────────────────────────────────────
  loki:
    image: grafana/loki:2.9.7
    ports:
      - "3100:3100"
    volumes:
      - ./loki-config:/etc/loki
      - lokidata:/loki
    command: -config.file=/etc/loki/loki.yml

  # ─────────────────────────────────────────────
  # Jaeger (distributed tracing)
  # ─────────────────────────────────────────────
  jaeger:
    image: jaegertracing/all-in-one:1.56
    ports:
      - "16686:16686"   # Jaeger UI
      - "14250:14250"   # gRPC collector
      - "6831:6831/udp" # UDP Thrift
    environment:
      COLLECTOR_OTLP_ENABLED: "true"

  # ─────────────────────────────────────────────
  # OpenTelemetry Collector (telemetry pipeline)
  # ─────────────────────────────────────────────
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.97.0
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics (self-monitoring)
    volumes:
      - ./otel-config:/etc/otel
    command: --config=/etc/otel/otel-collector.yml
    depends_on:
      - jaeger
      - prometheus
      - loki

  # ─────────────────────────────────────────────
  # Kafka (event bus for observability events)
  # ─────────────────────────────────────────────
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    volumes:
      - zkdata:/var/lib/zookeeper/data
      - zklog:/var/lib/zookeeper/log

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    depends_on:
      - zookeeper
    volumes:
      - kafkadata:/var/lib/kafka/data

volumes:
  pgdata:
  promdata:
  grafanadata:
  lokidata:
  zkdata:
  zklog:
  kafkadata:
